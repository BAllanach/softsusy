#!/bin/sh

# directory of this script
BASEDIR=$(dirname $0)

# path to the NMSSMTools directory
NMSSMTOOLS_PATH="@NMSSMTOOLS_PATH@"

if test $# -ne 2; then
    cat <<EOF
Usage: ./`basename $0` slha-input-file slha-output-file
EOF
    exit 1
fi

if ! test -d "${NMSSMTOOLS_PATH}"; then
    echo "Error: Cannot find NMSSMTools directory \"${nmssmtools_dir}\""
    exit 1
fi

if ! test -x "${NMSSMTOOLS_PATH}/main/nmProcessSpec"; then
    echo "Error: Cannot find ${NMSSMTOOLS_PATH}/main/nmProcessSpec"
    echo "   Please run ./setup_nmssmtools.sh --nmssmtools-dir=/path/to/NMSSMTools --compile"
    exit 1
fi

slha_input_file="$1"
slha_output_file="$2"

if ! test -r "${slha_input_file}"; then
    echo "Error: cannot open SLHA input file \"${slha_input_file}\""
    exit 1
fi

${BASEDIR}/softpoint.x leshouches < ${slha_input_file} > ${slha_output_file}

if test $? -ne 0; then
    echo "Warning: invalid point"
    exit 1
fi

cp ${slha_output_file} ${NMSSMTOOLS_PATH}/main/slha_nmssm
(cd ${NMSSMTOOLS_PATH}/main/ && ./nmProcessSpec)

if test $? -ne 0; then
    echo "Error: NMSSMTools could not calculate the decays"
    exit 1
fi

decay_output_file="${NMSSMTOOLS_PATH}/main/nmProcessSpec-decay"
omega_output_file="${NMSSMTOOLS_PATH}/main/nmProcessSpec-omega"

if ! test -r "${decay_output_file}"; then
    echo "Error: cannot open decay output file \"${decay_output_file}\""
    exit 1
fi

echo "\n" >> "${slha_output_file}"
cat "${decay_output_file}" >> "${slha_output_file}"
